tinymce.PluginManager.add("evo_view",function(a){function b(a){return c(a,"evo-view-wrap")}function c(a,b){for(;a&&a.parentNode;){if(a.className&&-1!==(" "+a.className+" ").indexOf(" "+b+" "))return a;a=a.parentNode}return!1}function d(a){a.stopPropagation()}function e(b,c){var d=b?"before":"after",e=b?0:1;i(),a.selection.setCursorLocation(a.dom.select(".evo-view-selection-"+d,c)[0],e),a.nodeChanged()}function f(b,c,d){var f=a.dom,g=f.create("p");x.ie&&x.ie<11||(g.innerHTML='<br data-mce-bogus="1">'),c?b.parentNode.insertBefore(g,b):f.insertAfter(g,b),i(),c&&d===y.ENTER?e(c,b):a.selection.setCursorLocation(g,0),a.nodeChanged()}function g(b){a.undoManager.transact(function(){evo.views.remove(a,b)})}function h(c){var e,f=a.dom;c&&(c!==n&&(a.getBody().focus(),i(),n=c,o=b(c),f.setAttrib(c,"data-mce-selected",1),f.addClass(n,"evo-view-selected"),e=f.create("div",{"class":"evo-view-clipboard",contenteditable:"true"},evo.views.getText(c)),a.dom.select(".evo-view-body",c)[0].appendChild(e),f.bind(e,"beforedeactivate focusin focusout",d),f.bind(n,"beforedeactivate focusin focusout",d),C?a.selection.select(e):a.selection.select(e,!0)),a.nodeChanged(),a.fire("evo-view-selected",c))}function i(){var b,c=a.dom;n&&(b=a.dom.select(".evo-view-clipboard",n)[0],c.unbind(b),c.remove(b),c.unbind(n,"beforedeactivate focusin focusout click mouseup",d),c.setAttrib(n,"data-mce-selected",null),c.removeClass(n,"evo-view-selected")),n=null,o=null}function j(a,b){return window.decodeURIComponent(b)}function k(a){return a.replace(/<(?:div|span)[^>]+data-evo-view-text="([^"]+)"[^>]*>(?:[\s\S]+?evo-view-selection-after[^>]+>[^<>]*<\/p>\s*|\.)<\/(?:div|span)>/g,j).replace(/<p [^>]*?data-evo-view-marker="([^"]+)"[^>]*>[\s\S]*?<\/p>/g,j)}function l(a){w("div[data-evo-view-text], span[data-evo-view-text], p[data-evo-view-marker]",a).each(function(a,b){b.innerHTML="."})}function m(a){return 47>=a&&a!==y.SPACEBAR&&a!==y.ENTER&&a!==y.DELETE&&a!==y.BACKSPACE&&(37>a||a>40)||a>=224||a>=144&&150>=a||a>=91&&93>=a||a>=112&&135>=a}var n,o,p,q,r,s,t,u,v,w=a.$,x=tinymce.Env,y=tinymce.util.VK,z=tinymce.dom.TreeWalker,A=!1,B=!0,C=/iPad|iPod|iPhone/.test(navigator.userAgent),D=["image","thumbnail","inline"];return a.on("BeforeAddUndo",function(a){a.level.content&&(a.level.content=k(a.level.content))}),a.on("BeforeSetContent",function(b){var c;if(b.selection||evo.views.unbind(),b.content){if(!b.load&&(n&&g(n),c=a.selection.getNode(),c&&c!==a.getBody()&&/^\s*https?:\/\/\S+\s*$/i.test(b.content))){if(c=a.dom.getParent(c,"p"),!c||!/^[\s\uFEFF\u00A0]*$/.test(w(c).text()||""))return;c.innerHTML=""}b.content=evo.views.setMarkers(b.content)}}),a.on("pastePreProcess",function(a){var b=a.content;b&&(b=tinymce.trim(b.replace(/<[^>]+>/g,"")),/^https?:\/\/\S+$/i.test(b)&&(a.content=b))}),a.on("SetContent",function(){evo.views.render()}),a.on("click",function(c){var d,f,g,h=c.clientX,i=c.clientY,j=a.getBody(),k=j.getBoundingClientRect(),l=j.firstChild,m=j.lastChild;l&&m&&(d=l.getBoundingClientRect(),f=m.getBoundingClientRect(),i<d.top&&(g=b(l))?(e(!0,g),c.preventDefault()):i>f.bottom&&(g=b(m))?(e(!1,g),c.preventDefault()):(h<k.left||h>k.right)&&tinymce.each(a.dom.select(".evo-view-wrap"),function(a){var b=a.getBoundingClientRect();return i<b.top?!1:i>=b.top&&i<=b.bottom?(h<k.left?(e(!0,a),c.preventDefault()):h>k.right&&(e(!1,a),c.preventDefault()),!1):void 0}))}),a.on("init",function(){var c=!1,d=a.selection,e=window.MutationObserver||window.WebKitMutationObserver;a.on("BeforeSetContent",function(){var c,e,f=b(d.getNode());f&&(!f.nextSibling||b(f.nextSibling)?(e=a.getDoc().createTextNode(""),a.dom.insertAfter(e,f)):(c=new z(f.nextSibling,f.nextSibling),e=c.next()),d.select(e),d.collapse(!0))}),a.dom.bind(a.getDoc(),"touchmove",function(){c=!0}),a.on("mousedown mouseup click touchend",function(a){var d=b(a.target);return B=!1,d?(a.stopImmediatePropagation(),a.preventDefault(),"touchend"===a.type&&c?c=!1:h(d),!1):("touchend"!==a.type&&"mousedown"!==a.type||i(),void("touchend"===a.type&&c&&(c=!1)))},!0),e&&new e(function(){a.fire("evo-body-class-change")}).observe(a.getBody(),{attributes:!0,attributeFilter:["class"]}),tinymce.Env.ie&&a.dom.bind(a.getBody(),"controlselect mscontrolselect",function(a){b(a.target)&&a.preventDefault()})}),a.on("PreProcess",function(a){l(a.node)},!0),a.on("hide",function(){evo.views.unbind(),i(),l()}),a.on("PostProcess",function(a){a.content&&(a.content=a.content.replace(/<(?:div|span) [^>]*?data-evo-view-text="([^"]+)"[^>]*>[\s\S]*?<\/(?:div|span)>/g,j).replace(/<p [^>]*?data-evo-view-marker="([^"]+)"[^>]*>[\s\S]*?<\/p>/g,j))}),a.on("keydown",function(c){var d,j,k,l,o,p,r,s=c.keyCode,t=a.dom,u=a.selection;if(n){if((c.metaKey||c.ctrlKey)&&s!==y.BACKSPACE&&86!==s||s>=112&&123>=s)return void((c.metaKey||c.ctrlKey)&&88===s&&(A=n));if(j=b(u.getNode()),j!==n)return void i();s===y.LEFT?(e(!0,j),c.preventDefault()):s===y.UP?(j.previousSibling?b(j.previousSibling)?e(!0,j.previousSibling):(i(),u.select(j.previousSibling,!0),u.collapse()):e(!0,j),c.preventDefault()):s===y.RIGHT?(e(!1,j),c.preventDefault()):s===y.DOWN?(j.nextSibling?b(j.nextSibling)?e(!1,j.nextSibling):(i(),u.setCursorLocation(j.nextSibling,0)):e(!1,j),c.preventDefault()):m(s)||(g(n),s!==y.ENTER&&s!==y.DELETE&&s!==y.BACKSPACE||c.preventDefault())}else{if(c.metaKey||c.ctrlKey||s>=112&&123>=s)return;if(d=u.getNode(),q=d,j=b(d),u.isCollapsed()||(o=u.getRng(),(j=b(o.endContainer))?(p=o.cloneRange(),u.select(j.previousSibling,!0),u.collapse(),r=u.getRng(),p.setEnd(r.endContainer,r.endOffset),u.setRng(p)):(j=b(o.startContainer))&&(p=o.cloneRange(),p.setStart(j.nextSibling,0),u.setRng(p))),!j)return void(c.keyCode===y.BACKSPACE&&(a.dom.isEmpty(d)?(j=b(d.previousSibling))&&(e(!1,j),a.dom.remove(d),c.preventDefault()):(o=u.getRng())&&0===o.startOffset&&0===o.endOffset&&(j=b(d.previousSibling))&&(e(!1,j),c.preventDefault())));if(!(k=t.hasClass(j,"evo-view-selection-before"))&&!(l=t.hasClass(j,"evo-view-selection-after")))return;if(m(s))return;l&&s===y.UP||k&&s===y.BACKSPACE?(j.previousSibling?b(j.previousSibling)?e(!1,j.previousSibling):t.isEmpty(j.previousSibling)&&s===y.BACKSPACE?t.remove(j.previousSibling):(u.select(j.previousSibling,!0),u.collapse()):e(!0,j),c.preventDefault()):!l||s!==y.DOWN&&s!==y.RIGHT?!k||s!==y.UP&&s!==y.LEFT?k&&s===y.DOWN?(j.nextSibling?b(j.nextSibling)?e(!0,j.nextSibling):u.setCursorLocation(j.nextSibling,0):e(!1,j),c.preventDefault()):l&&s===y.LEFT||k&&s===y.RIGHT?(h(j),c.preventDefault()):l&&s===y.BACKSPACE?(g(j),c.preventDefault()):l?f(j):k&&f(j,!0,s):(j.previousSibling&&(b(j.previousSibling)?e(s===y.UP,j.previousSibling):(u.select(j.previousSibling,!0),u.collapse())),c.preventDefault()):(j.nextSibling&&(b(j.nextSibling)?e(s===y.RIGHT,j.nextSibling):u.setCursorLocation(j.nextSibling,0)),c.preventDefault()),s===y.ENTER&&c.preventDefault()}}),a.on("keyup",function(){A&&(g(A),A=!1)}),a.on("focus",function(){var c;s=!0,a.dom.addClass(a.getBody(),"has-focus"),B&&(c=b(a.getBody().firstChild))&&e(!0,c),B=!1}),a.on("blur",function(){s=!1,a.dom.removeClass(a.getBody(),"has-focus")}),a.on("NodeChange",function(d){var f=a.dom,g=a.dom.select(".evo-view-wrap"),h=d.element.className,j=b(d.element),k=q;if(q=!1,clearInterval(p),tinymce.each(g,function(a){a.className&&(a.className=a.className.replace(/ ?\bevo-view-(?:selection-before|selection-after|cursor-hide)\b/g,""))}),s&&j)if("evo-view-selection-before"!==h&&"evo-view-selection-after"!==h||!a.selection.isCollapsed())c(d.element,"evo-view-clipboard")||r||(i(),r++,e(!0,j));else{if(r=0,i(),k===j.previousSibling)return void e(!0,j);if(k===j.nextSibling)return void e(!1,j);f.addClass(j,h),p=setInterval(function(){f.hasClass(j,"evo-view-cursor-hide")?f.removeClass(j,"evo-view-cursor-hide"):f.addClass(j,"evo-view-cursor-hide")},500)}}),a.on("BeforeExecCommand",function(){var c,d=a.selection.getNode();d&&((u="evo-view-selection-before"===d.className)||"evo-view-selection-after"===d.className)&&(c=b(d))&&(f(c,u),t=c)}),a.on("ExecCommand",function(){var b,c;n&&(b=n,i(),h(b)),t&&(c=t[u?"previousSibling":"nextSibling"],c&&"P"===c.nodeName&&a.dom.isEmpty(c)&&(a.dom.remove(c),e(u,t)),t=!1)}),a.on("ResolveName",function(c){a.dom.hasClass(c.target,"evo-view-wrap")?(c.name=a.dom.getAttrib(c.target,"data-evo-view-type")||"evo-view",c.stopPropagation()):b(c.target)&&(c.preventDefault(),c.stopPropagation())}),a.addButton("evo_image",{text:"inline image",icon:!1,tooltip:evo_js_lang_edit_image,onclick:function(){if(!a.getParam("postID"))return alert(evo_js_lang_alert_before_insert),!1;var b;if(o&&(b=o.getAttribute("data-evo-view-type")),-1==D.indexOf(b)){return openModalWindow('<span class="loader_img loader_user_report absolute_center" title="'+evo_js_lang_loading+'..."></span>',"80%","",!0,evo_js_lang_select_image_insert,"",!0),jQuery.ajax({type:"POST",url:a.getParam("modal_url"),success:function(a){openModalWindow(a,"90%","80%",!0,"Select image","")}}),!1}var c=decodeURIComponent(n.getAttribute("data-evo-view-text"));evo_item_image_edit(a.settings.blog_ID,c)},onPostRender:function(){var b=this;a.on("NodeChange",function(a){var c;o&&(c=o.getAttribute("data-evo-view-type"));var d=-1!=D.indexOf(c);b.active(d)})}}),a.on("evotoolbar",function(a){n&&(a.element=n,a.toolbar=v)}),a.evo=a.evo||{},a.evo.getView=b,a.evo.setViewCursor=e,{getView:b}});