tinymce.PluginManager.add( 'b2evo_shorttags', function( editor )
{

	var selectedView = null;
	var re = /\[(image|thumbnail|inline):(\d+):?([^\[\]]*)\]/g;

	editor.addButton( 'evo_inline', {
		text: 'Edit inline',
		icon: false,
		tooltip: 'Edit inline',
		onclick: function() {
			var selection = editor.selection;
			evo_item_image_edit( editor.settings.blog_ID, selection.getContent() );
		},
		onPostRender: function()
		{
			var inlineButton = this;
			editor.on( 'NodeChange', function( event ) {
				inlineButton.disabled( selectedView == null );
			} );
		}
	} )

	editor.on( 'keyup mouseup touchend', function( event ) {
		var dom = editor.dom,
				selection = editor.selection,
				range = selection.getRng();

		if( range.startContainer == range.endContainer )
		{
			selectedView = null;
			var match, found = false;
			while( ( match = re.exec( range.startContainer.nodeValue ) ) !== null && found == false )
			{
				if( ( ( range.startOffset == range.endOffset ) && ( range.startOffset > match.index ) && ( range.endOffset < ( match.index + match[0].length ) ) ) ||
					( ( range.startOffset != range.endOffset ) && ( range.startOffset >= match.index ) && ( range.endOffset <= ( match.index + match[0].length ) ) ) )
				{
					found = true;
					range.setStart( range.startContainer, match.index );
					range.setEnd( range.startContainer, match.index + match[0].length );
					selection.setRng( range );
					selectedView = selection.getSel();
				}
			}
		}
	} );

} );

